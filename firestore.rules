// ===============================================================
// ðŸ”’ Firestore Security Rules â€” DraftClub v1.2 (Optimized)
// ===============================================================
// Protege perfiles, publicaciones, likes, comentarios y reportes.
// Compatible con futuras funciones (feed_home, notifications, etc.)
// ===============================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================================================
    // ðŸ‘¤ USERS â€” cada usuario solo puede modificar su propio doc
    // ===========================================================
    match /users/{uid} {
      allow read: if true; // pÃºblico (perfiles visibles)
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // ===========================================================
    // ðŸ“° POSTS â€” publicaciones sociales (feed)
    // ===========================================================
    match /posts/{postId} {
      // ðŸ”¹ Lectura pÃºblica
      allow read: if true;

      // ðŸ”¹ Crear solo si el usuario es el autor
      allow create: if request.auth != null
                    && request.auth.uid == request.resource.data.authorId
                    && (request.resource.data.createdAt is timestamp)
                    && (request.resource.data.type in ['photo', 'video'])
                    && (request.resource.data.city is string)
                    && (request.resource.data.caption is string)
                    && (request.resource.data.mediaUrls is list)
                    && request.resource.data.caption.size() < 2200
                    && request.resource.data.mediaUrls.size() <= 5;

      // ðŸ”¹ Editar solo si es el autor del post existente
      allow update: if request.auth != null
                    && resource.data.authorId == request.auth.uid;

      // ðŸ”¹ Eliminar solo si es el autor
      allow delete: if request.auth != null
                     && resource.data.authorId == request.auth.uid;
    }

    // ===========================================================
    // â¤ï¸ POST_LIKES â€” cada usuario solo puede dar/quitar like a posts
    // ===========================================================
    match /post_likes/{postId}/likes/{uid} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // ===========================================================
    // ðŸ’¬ POST_COMMENTS â€” comentarios pÃºblicos, pero seguros
    // ===========================================================
    match /post_comments/{postId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.authorId == request.auth.uid
                    && (request.resource.data.text is string)
                    && (request.resource.data.text.size() > 0)
                    && (request.resource.data.text.size() <= 500)
                    && (request.resource.data.createdAt is timestamp);
      allow delete: if request.auth != null
                     && resource.data.authorId == request.auth.uid;
    }

    // ===========================================================
    // ðŸš© REPORTS â€” reportes de contenido
    // ===========================================================
    match /reports/{reportId} {
      allow create: if request.auth != null;
      allow read, update, delete: if false; // solo admins
    }

    // ===========================================================
    // ðŸ  FEED_HOME â€” timeline materializado (fan-out)
    // ===========================================================
    match /feed_home/{uid}/items/{itemId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // solo Cloud Functions
    }

    // ===========================================================
    // âš™ï¸ ROOMS / TOURNAMENTS (prototipo)
    // ===========================================================
    match /rooms/{roomId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ===========================================================
    // ðŸ§± DEFAULT DENY â€” bloquea todo lo no definido arriba
    // ===========================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}